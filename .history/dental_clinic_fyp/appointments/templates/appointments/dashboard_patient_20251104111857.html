{% extends "users/base.html" %}
{% load static %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<style>
/* Dashboard layout & styles (unchanged) */
.dashboard-container { display: flex; gap: 25px; margin: 40px; flex-wrap: wrap; }
.dashboard-header {
  margin: 30px 40px;
  background: linear-gradient(160deg, #002e5e 0%, #001f3f 100%);
  color: white;
  padding: 25px 30px;
  border-radius: 12px;
  text-shadow: #3B054D;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}
.dashboard-header h2 { margin:0; font-weight:700; font-size:1.8rem; }
.dashboard-header p { margin:5px 0 0; font-size:1rem; opacity:0.85; }

/* Quick Stats */
.quick-stats { display:flex; justify-content:space-between; gap:20px; margin:15px 40px; flex-wrap:wrap; }
.quick-card { flex:1; min-width:220px; max-width:280px; border-left:5px solid #004080; padding:15px 18px; border-radius:10px; background:linear-gradient(145deg,#f1f3f8,#e2e6ef); box-shadow:0 3px 10px rgba(0,0,0,0.1); font-size:0.95rem; font-weight:500; color:#1a1a1a; transition:all 0.25s ease; }
.quick-card:hover { transform:translateY(-4px); box-shadow:0 8px 18px rgba(0,0,0,0.15); }
.quick-card strong { color:#002f5f; font-weight:600; }

/* Dashboard Card */
.dashboard-card { flex:1; min-width:340px; background:linear-gradient(180deg,#ffffff 0%,#f5f7fa 100%); padding:25px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.1); transition:transform 0.2s,box-shadow 0.2s; border-top:4px solid #003366; }
.dashboard-card:hover { transform:translateY(-5px); box-shadow:0 8px 25px rgba(0,0,0,0.18); }

/* Doctor Profile Card */
#doctor-profile-card { display:none; margin-top:15px; padding:15px; border-radius:12px; background:linear-gradient(145deg,#ffffff,#f1f1f1); box-shadow:0 4px 15px rgba(0,0,0,0.1); transition:opacity 0.3s ease; max-width:400px; }
#doctor-profile-card img { border-radius:50%; width:100px; height:100px; object-fit:cover; margin-bottom:10px; }
#doctor-profile-card h5 { font-weight:700; color:#002f5f; margin-bottom:5px; }
#doctor-profile-card p { margin:2px 0; font-size:0.9rem; color:#1a1a1a; }

/* Form Styles */
.form-control { border-radius:8px; border:1px solid #888888; padding:10px; background-color:white; color:#1c1c1c; transition:border-color 0.2s, box-shadow 0.2s; }
.form-control:focus { border-color:#0056b3; box-shadow:0 0 6px rgba(0,86,179,0.25); }

/* Buttons */
.btn-blue { background:linear-gradient(135deg,#1a237e,#6a1b9a); color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:600; box-shadow:0 3px 12px rgba(0,0,0,0.2); transition:background 0.3s,transform 0.2s; }
.btn-blue:hover { background:linear-gradient(135deg,#0d145f,#4b0f6b); transform:translateY(-2px); }

/* Alerts */
.alert { border-radius:6px; border-left:5px solid #336699; padding:10px; font-weight:500; }
.alert.error { background-color:#ffdcdc;color:#a83232; }
.alert.success { background-color:#d6eadf;color:#0a5a35; }
.alert.warning { background-color:#fff1d6;color:#7f5e00; }
.alert.info { background-color:#d7e4f5;color:#114b8b; }
</style>

<div class="dashboard-header">
  <h2>Welcome, {{ request.user.username }} ðŸ‘‹</h2>
  <p><span id="today-date">{{ now|date:"l, F j, Y" }}</span> <span id="current-time"></span></p>
</div>

<div class="quick-stats">
  <div class="quick-card">
    ðŸ“… Latest Appointment:<br>
    {% if next_appointment %}
      <strong>{{ next_appointment.date|date:"l, F j, Y" }}</strong> <br>
      <strong>{{ next_appointment.doctor.user.username }}</strong><br>
      {% if next_appointment.status|lower in "canceled cancelled" %}
        <span style="color:#a83232;font-weight:600;">(Cancelled)</span>
      {% endif %}
    {% else %}
      <strong>No upcoming appointment</strong>
    {% endif %}
  </div>
  <div class="quick-card">
    ðŸ¦· Total Appointments: <strong>{{ total_appointments }}</strong>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-card">
    {% if messages %}
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <h3 style="color:#002f5f;font-weight:700;margin-bottom:20px;border-left:6px solid #007bff;padding-left:10px;">
      Book Appointment
    </h3>

    <form method="post" action="{% url 'appointments:create_appointment' %}">
      {% csrf_token %}
      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Doctor</label>
        <select name="doctor" id="doctor-select" class="form-control" required>
          <option value="" selected disabled>Select a Doctor</option>
          {% for doctor in doctors %}
            <option value="{{ doctor.id }}"
                    data-pic="{{ doctor.profile_pic_url|escapejs }}"
                    data-degree="{{ doctor.degree|default:''|escapejs }}"
                    data-specialization="{{ doctor.specialization|default:''|escapejs }}"
                    data-experience="{{ doctor.experience_years|default:'' }}"
                    data-bio="{{ doctor.bio|default:''|escapejs }}">
              {{ doctor.full_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Doctor Profile Card -->
      <div id="doctor-profile-card">
        <div class="text-center">
          <img id="doctor-profile-pic" src="/static/images/default_profile.png" alt="Profile Picture">
        </div>
        <h5 id="doctor-name"></h5>
        <p id="doctor-degree"></p>
        <p id="doctor-specialization"></p>
        <p id="doctor-experience"></p>
        <p id="doctor-bio"></p>
      </div>

      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Appointment Date</label>
        <input type="date" name="date" class="form-control" required id="appointment-date">
      </div>

      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Appointment Time</label>
        <input type="time" name="time" class="form-control" required min="09:00" max="18:00" id="appointment-time">
        <small style="color:#a83232;">Appointments allowed only between 9:00 AM and 6:00 PM</small>
      </div>

      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Notes</label>
        <textarea name="notes" class="form-control" rows="2"></textarea>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <button type="submit" class="btn-blue">Book Appointment</button>
        <a href="{% url 'appointments:appointment_list' %}" class="btn-blue" style="background:#1f3d66;">View Appointments</a>
      </div>
    </form>
  </div>
</div>

<script>
  const doctorSelect = document.getElementById('doctor-select');
  const profileCard = document.getElementById('doctor-profile-card');

  doctorSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      if (!selectedOption || !selectedOption.value) {
          profileCard.style.display = 'none';
          return;
      }

      const pic = selectedOption.dataset.pic || '/static/images/default_profile.png';
      const name = selectedOption.text;
      const degree = selectedOption.dataset.degree || '';
      const specialization = selectedOption.dataset.specialization || '';
      const experience = selectedOption.dataset.experience ? `${selectedOption.dataset.experience} years experience` : '';
      const bio = selectedOption.dataset.bio || '';

      document.getElementById('doctor-profile-pic').src = pic;
      document.getElementById('doctor-name').innerText = name;
      document.getElementById('doctor-degree').innerText = degree ? `Degree: ${degree}` : '';
      document.getElementById('doctor-specialization').innerText = specialization ? `Specialization: ${specialization}` : '';
      document.getElementById('doctor-experience').innerText = experience;
      document.getElementById('doctor-bio').innerText = bio ? `Bio: ${bio}` : '';

      profileCard.style.display = 'block';
      profileCard.style.opacity = 0;
      let op = 0;
      const fade = setInterval(() => {
          if(op >= 1) clearInterval(fade);
          else { profileCard.style.opacity = op; op += 0.1; }
      }, 30);
  });

  // Restrict past dates
  const dateInput = document.getElementById('appointment-date');
  const today = new Date();
  dateInput.min = today.toISOString().split('T')[0];
  dateInput.addEventListener('input', function() {
      const selected = new Date(this.value);
      this.style.border = selected < today ? '2px solid #a83232' : '1px solid #888';
  });

  // Restrict time
  const timeInput = document.getElementById('appointment-time');
  const minTime = 9, maxTime = 18;
  function clampTime() {
      if(!timeInput.value) return;
      let [hours, minutes] = timeInput.value.split(':').map(Number);
      if(hours < minTime) hours = minTime;
      if(hours > maxTime) hours = maxTime;
      timeInput.value = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
  }
  timeInput.addEventListener('input', clampTime);
  timeInput.addEventListener('blur', clampTime);
  timeInput.addEventListener('wheel', clampTime);
</script>

{% endblock %}
