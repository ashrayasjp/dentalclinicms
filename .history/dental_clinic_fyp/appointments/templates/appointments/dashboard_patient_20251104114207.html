{% extends "users/base.html" %}
{% load static %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<style>
/* ... your existing dashboard styles ... */
#doctor-info { display:none; margin-top:15px; padding:10px; border:1px solid #ccc; border-radius:8px; background:#f9f9f9; }
#doctor-info img { width:80px; border-radius:50%; float:right; margin-left:15px; }
</style>

<div class="dashboard-header">
  <h2>Welcome, {{ request.user.username }} ðŸ‘‹</h2>
  <p><span id="today-date">{{ now|date:"l, F j, Y" }}</span></p>
</div>

<div class="quick-stats">
  <div class="quick-card">
    ðŸ“… Latest Appointment:<br>
    {% if next_appointment %}
      <strong>{{ next_appointment.date|date:"l, F j, Y" }}</strong> <br>
      <strong>{{ next_appointment.doctor.user.username }}</strong>
      {% if next_appointment.status|lower == "canceled" or next_appointment.status|lower == "cancelled" %}
        <span style="color:#a83232;font-weight:600;">(Cancelled)</span>
      {% endif %}
    {% else %}
      <strong>No upcoming appointment</strong>
    {% endif %}
  </div>

  <div class="quick-card">
    ðŸ¦· Total Appointments: <strong>{{ total_appointments }}</strong>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-card">
    {% if messages %}
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <h3>Book Appointment</h3>

    <form method="post" action="{% url 'appointments:create_appointment' %}">
      {% csrf_token %}
      <div class="mb-3">
        <label>Doctor</label>
        <select name="doctor" id="doctor-select" class="form-control" required>
          <option value="" selected disabled>Select a Doctor</option>
          {% for doctor in doctors %}
            <option value="{{ doctor.id }}">Dr. {{ doctor.user.first_name }} {{ doctor.user.last_name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Doctor Info Panel -->
      <div id="doctor-info">
        <img id="doc-pic" src="" alt="Doctor Picture">
        <p><strong>Name:</strong> <span id="doc-name"></span></p>
        <p><strong>Degree:</strong> <span id="doc-degree"></span></p>
        <p><strong>Specialization:</strong> <span id="doc-specialization"></span></p>
        <p><strong>Experience:</strong> <span id="doc-experience"></span> years</p>
        <p><strong>Bio:</strong> <span id="doc-bio"></span></p>
        <a id="doc-new-tab" href="#" target="_blank" style="display:inline-block;margin-top:10px;color:#1a73e8;">View Full Profile</a>
      </div>

      <div class="mb-3">
        <label>Appointment Date</label>
        <input type="date" name="date" class="form-control" required id="appointment-date">
      </div>

      <div class="mb-3">
        <label>Appointment Time</label>
        <input type="time" name="time" class="form-control" required min="09:00" max="18:00" id="appointment-time">
      </div>

      <div class="mb-3">
        <label>Notes</label>
        <textarea name="notes" class="form-control" rows="2"></textarea>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <button type="submit" class="btn-blue">Book Appointment</button>
        <a href="{% url 'appointments:appointment_list' %}" class="btn-blue" style="background:#1f3d66;">View Appointments</a>
      </div>
    </form>
  </div>
</div>

<script>
// Doctor AJAX Fetch
const doctorSelect = document.getElementById('doctor-select');
const doctorInfoDiv = document.getElementById('doctor-info');
doctorSelect.addEventListener('change', function() {
    const doctorId = this.value;
    if (!doctorId) return;
    fetch(`/appointments/doctor/${doctorId}/details/`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                doctorInfoDiv.style.display = 'none';
                alert(data.error);
                return;
            }
            document.getElementById('doc-name').textContent = data.full_name;
            document.getElementById('doc-degree').textContent = data.degree;
            document.getElementById('doc-specialization').textContent = data.specialization;
            document.getElementById('doc-experience').textContent = data.experience_years;
            document.getElementById('doc-bio').textContent = data.bio;
            document.getElementById('doc-pic').src = data.profile_picture;
            document.getElementById('doc-new-tab').href = `/doctor/${doctorId}/profile/`;  // optional profile page
            doctorInfoDiv.style.display = 'block';
        })
        .catch(err => console.error(err));
});

// Restrict past dates
const dateInput = document.getElementById('appointment-date');
const today = new Date();
dateInput.min = today.toISOString().split('T')[0];
</script>

{% endblock %}
