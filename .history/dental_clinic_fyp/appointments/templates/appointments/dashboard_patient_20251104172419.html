{% extends "users/base.html" %}
{% load static %}
{% block title %}Patient Dashboard{% endblock %}

{% block content %}
<style>
/* Dashboard layout */
.dashboard-container { display: flex; gap: 25px; margin: 40px; flex-wrap: wrap; }
.dashboard-header {
  margin: 30px 40px;
  background: linear-gradient(160deg, #002e5e 0%, #001f3f 100%);
  color: white;
  padding: 25px 30px;
  border-radius: 12px;
  text-shadow: #3B054D;
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}
.dashboard-header h2 { margin: 0; font-weight: 700; font-size: 1.8rem; }
.dashboard-header p { margin: 5px 0 0; font-size: 1rem; opacity: 0.85; }

/* Quick Stats */
.quick-stats { display: flex; justify-content: space-between; gap: 20px; margin: 15px 40px; flex-wrap: wrap; }
.quick-card { flex: 1; min-width: 220px; max-width: 280px; border-left: 5px solid #004080; padding: 15px 18px; border-radius: 10px; background: linear-gradient(145deg, #f1f3f8, #e2e6ef); box-shadow: 0 3px 10px rgba(0,0,0,0.1); font-size: 0.95rem; font-weight: 500; color: #1a1a1a; transition: all 0.25s ease; }
.quick-card strong { color: #002f5f; font-weight: 600; }

/* Main Dashboard Cards */
.dashboard-card { flex: 1; min-width: 340px; background: linear-gradient(180deg, #ffffff 0%, #f5f7fa 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-top: 4px solid #003366; }
.form-control { border-radius: 8px; border: 1px solid #888; padding: 10px; }
.form-control:focus { border-color: #0056b3; box-shadow: 0 0 6px rgba(0,86,179,0.25); }
.btn-blue { background: linear-gradient(135deg, #1a237e, #6a1b9a); color: white; border: none; padding: 10px 25px; border-radius: 8px; font-weight: 600; cursor: pointer; }
.btn-blue:hover { background: linear-gradient(135deg, #0d145f, #4b0f6b); }

/* Doctor details tab */
#doctor-details { display: none; border:1px solid #ccc; border-radius:12px; padding:15px; margin-top:20px; }
#doctor-details img { width:100px; height:100px; border-radius:50%; object-fit:cover; margin-bottom:10px; }
</style>

<div class="dashboard-header">
  <h2>Welcome, {{ request.user.username }} ðŸ‘‹</h2>
  <p>{{ now|date:"l, F j, Y" }}</p>
</div>

<div class="quick-stats">
  <div class="quick-card">
    ðŸ“… Latest Appointment:<br>
    {% if next_appointment %}
      <strong>{{ next_appointment.date|date:"l, F j, Y" }}</strong><br>
      <strong>{{ next_appointment.doctor.user.username }}</strong>
      {% if next_appointment.status|lower in "canceled cancelled" %}
        <span style="color:#a83232;font-weight:600;">(Cancelled)</span>
      {% endif %}
    {% else %}
      <strong>No upcoming appointment</strong>
    {% endif %}
  </div>

  <div class="quick-card">
    ðŸ¦· Total Appointments: <strong>{{ total_appointments }}</strong>
  </div>
</div>

<div class="dashboard-container">
  <div class="dashboard-card">
    {% if messages %}
      {% for message in messages %}
        <div class="alert {{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <h3 style="color:#002f5f;font-weight:700;margin-bottom:20px;">Book Appointment</h3>

    <form method="post" action="{% url 'appointments:create_appointment' %}">
      {% csrf_token %}

      <!-- Doctor Dropdown -->
      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Select Doctor</label>
        <select class="form-control" id="doctor-select" required>
          <option value="">-- Choose a Doctor --</option>
          {% for doctor in doctors %}
            <option value="{{ doctor.id }}">{{ doctor.full_name }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="doctor" id="selected-doctor">
      </div>

      <!-- Doctor Details -->
      <div id="doctor-details">
        <img id="doc-profile" src="" alt="Profile Picture">
        <h4 id="doc-name"></h4>
        <p><strong>Degree:</strong> <span id="doc-degree"></span></p>
        <p><strong>Specialization:</strong> <span id="doc-specialization"></span></p>
        <p><strong>Experience:</strong> <span id="doc-experience"></span> years</p>
        <p><strong>Bio:</strong> <span id="doc-bio"></span></p>
      </div>

      <!-- Appointment Date & Time -->
      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Appointment Date</label>
        <input type="date" name="date" class="form-control" required id="appointment-date">
      </div>
      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Appointment Time</label>
        <input type="time" name="time" class="form-control" required min="09:00" max="18:00" id="appointment-time">
        <small style="color:#a83232;">Appointments allowed only between 9:00 AM and 6:00 PM</small>
      </div>

      <div class="mb-3">
        <label style="font-weight:600;color:#002f5f;">Notes</label>
        <textarea name="notes" class="form-control" rows="2"></textarea>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <button type="submit" class="btn-blue">Book Appointment</button>
        <a href="{% url 'appointments:appointment_list' %}" class="btn-blue" style="background:#1f3d66;">View Appointments</a>
      </div>
    </form>
  </div>
</div>

<script>
  const doctorsData = {
    {% for doctor in doctors %}
      {{ doctor.id }}: {
        full_name: "{{ doctor.full_name|escapejs }}",
        degree: "{{ doctor.degree|default:'N/A'|escapejs }}",
        specialization: "{{ doctor.specialization|default:'N/A'|escapejs }}",
        experience_years: "{{ doctor.experience_years|default:'0' }}",
        bio: "{{ doctor.bio|default:'N/A'|escapejs }}",
        profile_picture: "{{ doctor.profile_picture|default:'/static/images/default_profile.png' }}"
      }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };

  const select = document.getElementById('doctor-select');
  select.addEventListener('change', function() {
    const docId = this.value;
    const detailsTab = document.getElementById('doctor-details');

    if (!docId) {
      detailsTab.style.display = 'none';
      document.getElementById('selected-doctor').value = '';
      return;
    }

    const doc = doctorsData[docId];
    document.getElementById('selected-doctor').value = docId;
    document.getElementById('doc-name').textContent = doc.full_name;
    document.getElementById('doc-degree').textContent = doc.degree;
    document.getElementById('doc-specialization').textContent = doc.specialization;
    document.getElementById('doc-experience').textContent = doc.experience_years;
    document.getElementById('doc-bio').textContent = doc.bio;
    document.getElementById('doc-profile').src = doc.profile_picture;

    detailsTab.style.display = 'block';
  });

  // Date restriction
  const dateInput = document.getElementById('appointment-date');
  const today = new Date();
  dateInput.min = today.toISOString().split('T')[0];

  // Time restriction
  const timeInput = document.getElementById('appointment-time');
  const minTime = 9;
  const maxTime = 18;
  function clampTime() {
      if (!timeInput.value) return;
      let [hours, minutes] = timeInput.value.split(':').map(Number);
      if (hours < minTime) hours = minTime;
      if (hours > maxTime) hours = maxTime;
      timeInput.value = `${String(hours).padStart(2,'0')}:${String(minutes).padStart(2,'0')}`;
  }
  timeInput.addEventListener('input', clampTime);
  timeInput.addEventListener('blur', clampTime);
</script>

{% endblock %}
